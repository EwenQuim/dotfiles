#!/bin/bash
# This script sets up secrets from Bitwarden
# It only runs once per machine (tracked by chezmoi)

set -e

# Check if bw (Bitwarden CLI) is available
if ! command -v bw &> /dev/null; then
    echo "Bitwarden CLI (bw) not found. Skipping secrets setup."
    echo "Install with: brew install bitwarden-cli"
    exit 0
fi

# Check if already logged in
if ! bw login --check &> /dev/null; then
    echo "Not logged into Bitwarden. Run 'bw login' first."
    exit 0
fi

# Unlock if needed
if [ -z "$BW_SESSION" ]; then
    echo "Bitwarden vault is locked. Run: export BW_SESSION=\$(bw unlock --raw)"
    exit 0
fi

echo "Setting up secrets from Bitwarden..."

# Create secrets.fish with API keys from Bitwarden
# Uncomment and customize the lines below based on your Bitwarden items
SECRETS_FILE="${HOME}/.config/fish/conf.d/secrets.fish"

cat > "$SECRETS_FILE" << 'EOF'
# Secrets loaded from Bitwarden - do not commit!
# This file is regenerated by chezmoi run_once script
EOF

# Example: Add secrets from Bitwarden
# Uncomment and modify these lines based on your actual Bitwarden items:
# echo "set -gx GITHUB_TOKEN $(bw get password 'GitHub Token')" >> "$SECRETS_FILE"
# echo "set -gx OPENAI_API_KEY $(bw get password 'OpenAI API')" >> "$SECRETS_FILE"

chmod 600 "$SECRETS_FILE"
echo "Secrets file created at $SECRETS_FILE"
