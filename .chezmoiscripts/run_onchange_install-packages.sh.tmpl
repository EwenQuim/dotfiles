#!/bin/bash
# Install packages using the appropriate package manager
# This script runs when the Brewfile changes (run_onchange_)

set -e

{{ if eq .chezmoi.os "darwin" -}}
# macOS: Install packages via Homebrew
echo "Installing packages via Homebrew..."

# Install Homebrew if not present
if ! command -v brew &> /dev/null; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

# Install packages from Brewfile
brew bundle --file="{{ .chezmoi.sourceDir }}/Brewfile"

{{ else if eq .chezmoi.os "linux" -}}
# Linux: Detect distro and use appropriate package manager
echo "Installing packages on Linux..."

if command -v apt-get &> /dev/null; then
    # Debian/Ubuntu
    sudo apt-get update
    sudo apt-get install -y \
        bat \
        fd-find \
        fish \
        fzf \
        git \
        jq \
        neovim \
        ripgrep \
        tree

    # Install starship
    if ! command -v starship &> /dev/null; then
        curl -sS https://starship.rs/install.sh | sh -s -- -y
    fi

    # Install zoxide
    if ! command -v zoxide &> /dev/null; then
        curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash
    fi

elif command -v pacman &> /dev/null; then
    # Arch Linux
    sudo pacman -Syu --noconfirm \
        bat \
        fd \
        fish \
        fzf \
        git \
        jq \
        neovim \
        ripgrep \
        starship \
        tree \
        zoxide

elif command -v dnf &> /dev/null; then
    # Fedora
    sudo dnf install -y \
        bat \
        fd-find \
        fish \
        fzf \
        git \
        jq \
        neovim \
        ripgrep \
        tree
fi

{{ end -}}

echo "Package installation complete!"
